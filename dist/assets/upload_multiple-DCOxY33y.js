import{Q as H,R as Q,r as u,d as W,ac as X,U as Y,Y as y,W as i,H as M,V as c,ab as S,x as a,X as s,a5 as _,_ as d,P as Z,Z as h,$ as I,u as G,L as J}from"./index-DrtXJ76k.js";import{g as K,q as ee,o as le}from"./VOverlay-D7KLqul2.js";import{b as D,d as te,V as A,a as N,e as ae}from"./VTextField-Cbwj9afB.js";import{V as se}from"./VForm-CzPAKgQp.js";import{a as re}from"./VSelect-DF8LjojY.js";import{V as ne}from"./VFileInput-BeFlB6NB.js";import{V as q,s as oe,p as ue,o as L}from"./VAvatar-D6tovhXD.js";import{d as ie,V as de,e as me,f as fe}from"./scopeId-C9l49y41.js";import{V as pe}from"./VListItemAction-CKCWm1MM.js";import{V as ve}from"./VSpacer-B133BwxA.js";import{V as ce}from"./VDialog-BZLPLVZ4.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css              */const Ve={key:1},ye={key:0},_e={key:1,class:"text-error"},b=20,Ie=H({__name:"upload_multiple",setup(be){const P=Q(),B=u([]),p=u(null),m=u(null),g=u(3),C=u(!1),T=u("form"),f=u([]),k=u(0),r=u(null),V=u(!1),U=u("");let v=0;async function E(){try{const l=await K();B.value=l||[]}catch(l){console.error("获取测验列表失败:",l)}}async function $(){if(!(!p.value||!m.value||m.value.length===0)){if(m.value.length>b){alert(`每次最多上传${b}篇作文`);return}C.value=!0,T.value="processing",k.value=0,v=0,f.value=m.value.map(l=>({file:l,status:"pending"})),r.value!==null&&(clearInterval(r.value),r.value=null),await x(v),C.value=!1}}async function x(l){var t,n;if(l>=f.value.length){F(),U.value="全部批改完成！",V.value=!0,setTimeout(()=>{V.value=!1,P.push("/essays")},5e3);return}v=l;const e=f.value[l];e.status="uploading";const o=new FormData;o.append("essayAssignmentId",p.value),o.append("imageFile",e.file),o.append("columnCount",g.value.toString());try{const w=await ee(p.value,e.file,g.value);e.submissionId=w.submissionId,e.status="polling",z(e)}catch(w){console.error(`上传文件 ${e.file.name} 失败:`,w),e.status="error",e.error=((n=(t=w.response)==null?void 0:t.data)==null?void 0:n.message)||"上传失败",F(),await x(v+1)}}function z(l){r.value!==null&&clearInterval(r.value),r.value=setInterval(()=>R(l),2e3)}async function R(l){var o,t;const e=f.value.find(n=>n.submissionId===l.submissionId);if(!e||e.status!=="polling"||!e.submissionId){r.value!==null&&(clearInterval(r.value),r.value=null);return}try{const n=await le(e.submissionId);n.judgeResult&&(e.status="completed",e.finalScore=n.finalScore,F(),r.value!==null&&(clearInterval(r.value),r.value=null),await x(v+1))}catch(n){console.error(`轮询提交 ${e.submissionId} 失败:`,n),e.status="error",e.error=((t=(o=n.response)==null?void 0:o.data)==null?void 0:t.message)||"处理失败",F(),r.value!==null&&(clearInterval(r.value),r.value=null),await x(v+1)}}function F(){const l=f.value.length;if(l===0){k.value=0;return}const e=f.value.filter(o=>o.status==="completed"||o.status==="error").length;k.value=Math.min(e/l*100,100)}function O(l){switch(l){case"pending":return"等待上传";case"uploading":return"上传中";case"polling":return"处理中";case"completed":return"已完成";case"error":return"失败";default:return l}}function j(l){if(l.preventDefault(),l.dataTransfer&&l.dataTransfer.files&&l.dataTransfer.files.length>0){const e=Array.from(l.dataTransfer.files);e.length>b?(alert(`每次最多上传${b}篇作文`),m.value=null):(m.value=e,J(()=>{p.value&&g.value>0&&$()}))}}return W(()=>{E()}),X(()=>{r.value!==null&&clearInterval(r.value)}),(l,e)=>{const o=Y("v-list-item-content");return i(),y("div",null,[e[15]||(e[15]=M("h1",{class:"text-h4 mb-4"},"批量上传作文并批改",-1)),T.value==="form"?(i(),c(A,{key:0},{default:s(()=>[a(D,null,{default:s(()=>[a(se,{onSubmit:_($,["prevent"])},{default:s(()=>[a(re,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=t=>p.value=t),items:B.value,"item-title":"title","item-value":"id",label:"选择测验",required:""},null,8,["modelValue","items"]),M("div",{class:"drag-file-area",onDragover:e[3]||(e[3]=_(()=>{},["prevent"])),onDragleave:e[4]||(e[4]=_(()=>{},["prevent"])),onDrop:_(j,["prevent"])},[a(ne,{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=t=>m.value=t),label:"选择作文图片（支持拖动文件到此处选择，最多20篇）",accept:"image/*",required:"",multiple:"","max-files":b,"show-size":"","prepend-icon":"mdi-upload",style:{background:"transparent"},onClick:e[2]||(e[2]=_(()=>{},["stop"]))},null,8,["modelValue"])],32),a(te,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=t=>g.value=t),modelModifiers:{number:!0},label:"分栏数",type:"number",required:""},null,8,["modelValue"]),a(q,{type:"submit",color:"primary",loading:C.value},{default:s(()=>e[8]||(e[8]=[d("提交")])),_:1,__:[8]},8,["loading"])]),_:1})]),_:1})]),_:1})):S("",!0),T.value==="processing"?(i(),y("div",Ve,[a(oe,{"model-value":k.value,color:"primary",height:"8",striped:"",class:"mb-4"},null,8,["model-value"]),a(A,null,{default:s(()=>[a(N,null,{default:s(()=>e[9]||(e[9]=[d("批量批改进度")])),_:1,__:[9]}),a(D,null,{default:s(()=>[a(ie,{dense:""},{default:s(()=>[(i(!0),y(Z,null,h(f.value,(t,n)=>(i(),c(de,{key:n},{default:s(()=>[a(o,null,{default:s(()=>[a(me,null,{default:s(()=>[d(I(t.file.name),1)]),_:2},1024),a(fe,null,{default:s(()=>[d(" 状态: "+I(O(t.status))+" ",1),t.status==="completed"?(i(),y("span",ye," - 得分: "+I(t.finalScore??"N/A"),1)):S("",!0),t.status==="error"?(i(),y("span",_e," - 错误: "+I(t.error??"未知错误"),1)):S("",!0)]),_:2},1024)]),_:2},1024),a(pe,null,{default:s(()=>[t.status==="uploading"||t.status==="polling"?(i(),c(ue,{key:0,indeterminate:"",size:"24",width:"3",color:"primary"})):t.status==="completed"?(i(),c(L,{key:1,color:"success"},{default:s(()=>e[10]||(e[10]=[d("mdi-check-circle")])),_:1,__:[10]})):t.status==="error"?(i(),c(L,{key:2,color:"error"},{default:s(()=>e[11]||(e[11]=[d("mdi-alert-circle")])),_:1,__:[11]})):(i(),c(L,{key:3},{default:s(()=>e[12]||(e[12]=[d("mdi-dots-horizontal")])),_:1,__:[12]}))]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})])):S("",!0),a(ce,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=t=>V.value=t),persistent:"","max-width":"300"},{default:s(()=>[a(A,null,{default:s(()=>[a(N,{class:"text-h6"},{default:s(()=>e[13]||(e[13]=[d("批改完成")])),_:1,__:[13]}),a(D,null,{default:s(()=>[d(I(U.value),1)]),_:1}),a(ae,null,{default:s(()=>[a(ve),a(q,{color:"primary",variant:"text",onClick:e[6]||(e[6]=t=>{V.value=!1,G(P).push("/essays")})},{default:s(()=>e[14]||(e[14]=[d("确定")])),_:1,__:[14]})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),$e=ge(Ie,[["__scopeId","data-v-e58d2797"]]);export{$e as default};
