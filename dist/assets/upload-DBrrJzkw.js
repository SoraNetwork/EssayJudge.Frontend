import{Q as F,R as M,r as o,d as N,Y as c,W as n,H as i,V as R,ab as g,X as s,x as a,a5 as q,_ as d,$ as p,P as A,Z as U}from"./index-DrtXJ76k.js";import{g as E,q as j,o as D}from"./VOverlay-D7KLqul2.js";import{b as V,d as L,V as y,a as I}from"./VTextField-Cbwj9afB.js";import{V as $}from"./VForm-CzPAKgQp.js";import{a as h}from"./VSelect-DF8LjojY.js";import{V as z}from"./VFileInput-BeFlB6NB.js";import{V as T,s as H,p as Q}from"./VAvatar-D6tovhXD.js";import{_ as W}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./scopeId-C9l49y41.js";const X={class:"d-flex justify-end"},Y={key:1},Z=F({__name:"upload",setup(G){const S=M(),C=o([]),v=o(null),f=o(null),_=o(3),b=o(!1),x=o(!1),m=o(!1),t=o({}),r=o(0);async function w(){try{const u=await E();C.value=u||[]}catch(u){console.error("获取测验列表失败:",u)}}async function B(){if(!(!v.value||!f.value)){b.value=!0,x.value=!0,r.value=0;try{const e=(await j(v.value,f.value,_.value)).submissionId;P(e)}catch(u){console.error("上传作文失败:",u),m.value=!1,r.value=0}finally{b.value=!1}}}function P(u){x.value=!1,m.value=!0,r.value=0;const e=setInterval(async()=>{try{const l=await D(u);t.value=l;let k=0;t.value.parsedText&&(k+=20),t.value.aiResults&&t.value.aiResults.length>0&&(k+=Math.min(t.value.aiResults.length,4)*20),r.value=Math.min(k,100),l.judgeResult&&(clearInterval(e),r.value=100,setTimeout(()=>{S.push(`/essays/${u}`)},500))}catch(l){console.error("轮询失败:",l),clearInterval(e),m.value=!1,t.value={},r.value=0}},2e3)}return N(()=>{w()}),(u,e)=>(n(),c("div",null,[e[8]||(e[8]=i("h1",{class:"text-h4 mb-4"},"上传作文并批改",-1)),!x.value&&!m.value?(n(),R(y,{key:0},{default:s(()=>[a(V,null,{default:s(()=>[a($,{onSubmit:q(B,["prevent"])},{default:s(()=>[a(h,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=l=>v.value=l),items:C.value,"item-title":"title","item-value":"id",label:"选择测验",required:""},null,8,["modelValue","items"]),a(z,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=l=>f.value=l),label:"选择作文图片（支持拖动文件到此处选择）",accept:"image/*",required:""},null,8,["modelValue"]),a(L,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=l=>_.value=l),modelModifiers:{number:!0},label:"分栏数",type:"number",required:""},null,8,["modelValue"]),i("div",X,[a(T,{type:"submit",color:"primary",loading:b.value,class:"mr-2"},{default:s(()=>e[3]||(e[3]=[d("提交")])),_:1,__:[3]},8,["loading"]),a(T,{color:"secondary",to:"/essays/upload_multiple","prepend-icon":"mdi-upload-multiple"},{default:s(()=>e[4]||(e[4]=[d("批量上传")])),_:1,__:[4]})])]),_:1})]),_:1})]),_:1})):g("",!0),m.value?(n(),c("div",Y,[a(H,{"model-value":r.value,color:"primary",height:"8",striped:"",class:"mb-4"},null,8,["model-value"]),a(y,{class:"mb-4"},{default:s(()=>[a(V,{class:"text-center"},{default:s(()=>[a(Q,{indeterminate:"",color:"primary",size:"64"}),e[5]||(e[5]=i("p",{class:"mt-4"},"正在批改中，请稍候...",-1)),i("p",null,"状态: "+p(t.value.status),1)]),_:1,__:[5]})]),_:1}),t.value.parsedText?(n(),R(y,{key:0,class:"mb-4"},{default:s(()=>[a(I,null,{default:s(()=>e[6]||(e[6]=[d("识别原文")])),_:1,__:[6]}),a(V,{class:"pre-wrap"},{default:s(()=>[d(p(t.value.parsedText),1)]),_:1})]),_:1})):g("",!0),t.value.aiResults&&t.value.aiResults.length>0?(n(),R(y,{key:1,class:"mb-4"},{default:s(()=>[a(I,null,{default:s(()=>e[7]||(e[7]=[d("AI 初步批改")])),_:1,__:[7]}),a(V,null,{default:s(()=>[i("ul",null,[(n(!0),c(A,null,U(t.value.aiResults,l=>(n(),c("li",{key:l.id},[i("strong",null,p(l.modelName)+":",1),d(" "+p(l.feedback)+" (得分: "+p(l.score)+") ",1)]))),128))])]),_:1})]),_:1})):g("",!0)])):g("",!0)]))}}),oe=W(Z,[["__scopeId","data-v-407a1ec9"]]);export{oe as default};
