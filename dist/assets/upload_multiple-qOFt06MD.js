import{Q as H,R as Q,r as u,d as W,ac as X,U as Y,Y as y,W as i,H as M,V as c,a0 as S,x as a,X as s,a6 as _,_ as d,P as Z,$ as h,Z as I,u as G,L as J}from"./index--uryIc9t.js";import{b as K,V as ee,m as le,n as te,c as ae,y as se,w as re}from"./VList-Bw5JRA7I.js";import{b as D,V as A,a as N,c as oe}from"./VCard-Baw6fKXM.js";import{V as ne}from"./VForm-E8O1qvQD.js";import{a as ue}from"./VSelect-C7-6oE3D.js";import{V as ie}from"./VFileInput-DFMlOF51.js";import{a as de}from"./VTextField-B7WNoRZT.js";import{V as q,v as me,q as pe,p as L}from"./VAvatar-Cjt3-t6c.js";import{V as fe}from"./VListItemAction-Btl8-JVK.js";import{V as ve}from"./VSpacer-mriSOV0H.js";import{V as ce}from"./VDialog-CJbZZ0LG.js";import{_ as ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./forwardRefs-TdIUcFqw.js";import"./VOverlay-CaEAIGL2.js";import"./dialog-transition-C45ZtiWV.js";import"./VChip-CTpQQSB7.js";/* empty css              */const Ve={key:1},ye={key:0},_e={key:1,class:"text-error"},b=20,Ie=H({__name:"upload_multiple",setup(be){const P=Q(),B=u([]),f=u(null),m=u(null),g=u(3),C=u(!1),T=u("form"),p=u([]),k=u(0),r=u(null),V=u(!1),U=u("");let v=0;async function E(){try{const l=await ae();B.value=l||[]}catch(l){console.error("获取测验列表失败:",l)}}async function $(){if(!(!f.value||!m.value||m.value.length===0)){if(m.value.length>b){alert(`每次最多上传${b}篇作文`);return}C.value=!0,T.value="processing",k.value=0,v=0,p.value=m.value.map(l=>({file:l,status:"pending"})),r.value!==null&&(clearInterval(r.value),r.value=null),await x(v),C.value=!1}}async function x(l){var t,o;if(l>=p.value.length){F(),U.value="全部批改完成！",V.value=!0,setTimeout(()=>{V.value=!1,P.push("/essays")},5e3);return}v=l;const e=p.value[l];e.status="uploading";const n=new FormData;n.append("essayAssignmentId",f.value),n.append("imageFile",e.file),n.append("columnCount",g.value.toString());try{const w=await se(f.value,e.file,g.value);e.submissionId=w.submissionId,e.status="polling",z(e)}catch(w){console.error(`上传文件 ${e.file.name} 失败:`,w),e.status="error",e.error=((o=(t=w.response)==null?void 0:t.data)==null?void 0:o.message)||"上传失败",F(),await x(v+1)}}function z(l){r.value!==null&&clearInterval(r.value),r.value=setInterval(()=>R(l),2e3)}async function R(l){var n,t;const e=p.value.find(o=>o.submissionId===l.submissionId);if(!e||e.status!=="polling"||!e.submissionId){r.value!==null&&(clearInterval(r.value),r.value=null);return}try{const o=await re(e.submissionId);o.judgeResult&&(e.status="completed",e.finalScore=o.finalScore,F(),r.value!==null&&(clearInterval(r.value),r.value=null),await x(v+1))}catch(o){console.error(`轮询提交 ${e.submissionId} 失败:`,o),e.status="error",e.error=((t=(n=o.response)==null?void 0:n.data)==null?void 0:t.message)||"处理失败",F(),r.value!==null&&(clearInterval(r.value),r.value=null),await x(v+1)}}function F(){const l=p.value.length;if(l===0){k.value=0;return}const e=p.value.filter(n=>n.status==="completed"||n.status==="error").length;k.value=Math.min(e/l*100,100)}function O(l){switch(l){case"pending":return"等待上传";case"uploading":return"上传中";case"polling":return"处理中";case"completed":return"已完成";case"error":return"失败";default:return l}}function j(l){if(l.preventDefault(),l.dataTransfer&&l.dataTransfer.files&&l.dataTransfer.files.length>0){const e=Array.from(l.dataTransfer.files);e.length>b?(alert(`每次最多上传${b}篇作文`),m.value=null):(m.value=e,J(()=>{f.value&&g.value>0&&$()}))}}return W(()=>{E()}),X(()=>{r.value!==null&&clearInterval(r.value)}),(l,e)=>{const n=Y("v-list-item-content");return i(),y("div",null,[e[15]||(e[15]=M("h1",{class:"text-h4 mb-4"},"批量上传作文并批改",-1)),T.value==="form"?(i(),c(A,{key:0},{default:s(()=>[a(D,null,{default:s(()=>[a(ne,{onSubmit:_($,["prevent"])},{default:s(()=>[a(ue,{modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=t=>f.value=t),items:B.value,"item-title":"title","item-value":"id",label:"选择测验",required:""},null,8,["modelValue","items"]),M("div",{class:"drag-file-area",onDragover:e[3]||(e[3]=_(()=>{},["prevent"])),onDragleave:e[4]||(e[4]=_(()=>{},["prevent"])),onDrop:_(j,["prevent"])},[a(ie,{modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=t=>m.value=t),label:"选择作文图片（支持拖动文件到此处选择，最多20篇）",accept:"image/*",required:"",multiple:"","max-files":b,"show-size":"","prepend-icon":"mdi-upload",style:{background:"transparent"},onClick:e[2]||(e[2]=_(()=>{},["stop"]))},null,8,["modelValue"])],32),a(de,{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=t=>g.value=t),modelModifiers:{number:!0},label:"分栏数",type:"number",required:""},null,8,["modelValue"]),a(q,{type:"submit",color:"primary",loading:C.value},{default:s(()=>e[8]||(e[8]=[d("提交")])),_:1,__:[8]},8,["loading"])]),_:1})]),_:1})]),_:1})):S("",!0),T.value==="processing"?(i(),y("div",Ve,[a(me,{"model-value":k.value,color:"primary",height:"8",striped:"",class:"mb-4"},null,8,["model-value"]),a(A,null,{default:s(()=>[a(N,null,{default:s(()=>e[9]||(e[9]=[d("批量批改进度")])),_:1,__:[9]}),a(D,null,{default:s(()=>[a(K,{dense:""},{default:s(()=>[(i(!0),y(Z,null,h(p.value,(t,o)=>(i(),c(ee,{key:o},{default:s(()=>[a(n,null,{default:s(()=>[a(le,null,{default:s(()=>[d(I(t.file.name),1)]),_:2},1024),a(te,null,{default:s(()=>[d(" 状态: "+I(O(t.status))+" ",1),t.status==="completed"?(i(),y("span",ye," - 得分: "+I(t.finalScore??"N/A"),1)):S("",!0),t.status==="error"?(i(),y("span",_e," - 错误: "+I(t.error??"未知错误"),1)):S("",!0)]),_:2},1024)]),_:2},1024),a(fe,null,{default:s(()=>[t.status==="uploading"||t.status==="polling"?(i(),c(pe,{key:0,indeterminate:"",size:"24",width:"3",color:"primary"})):t.status==="completed"?(i(),c(L,{key:1,color:"success"},{default:s(()=>e[10]||(e[10]=[d("mdi-check-circle")])),_:1,__:[10]})):t.status==="error"?(i(),c(L,{key:2,color:"error"},{default:s(()=>e[11]||(e[11]=[d("mdi-alert-circle")])),_:1,__:[11]})):(i(),c(L,{key:3},{default:s(()=>e[12]||(e[12]=[d("mdi-dots-horizontal")])),_:1,__:[12]}))]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})])):S("",!0),a(ce,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=t=>V.value=t),persistent:"","max-width":"300"},{default:s(()=>[a(A,null,{default:s(()=>[a(N,{class:"text-h6"},{default:s(()=>e[13]||(e[13]=[d("批改完成")])),_:1,__:[13]}),a(D,null,{default:s(()=>[d(I(U.value),1)]),_:1}),a(oe,null,{default:s(()=>[a(ve),a(q,{color:"primary",variant:"text",onClick:e[6]||(e[6]=t=>{V.value=!1,G(P).push("/essays")})},{default:s(()=>e[14]||(e[14]=[d("确定")])),_:1,__:[14]})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),Ee=ge(Ie,[["__scopeId","data-v-e58d2797"]]);export{Ee as default};
