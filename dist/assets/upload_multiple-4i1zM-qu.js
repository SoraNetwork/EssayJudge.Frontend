import{Q as se,R as le,r as c,d as oe,ao as te,U as ne,Y as I,W as u,H as T,V as v,a0 as k,x as t,X as o,aj as $,y as ae,_ as i,Z as b,P as U,$ as O,u as re,L as ue}from"./index-B1k2TmTq.js";import{V as q,x as z,b as ie,w as de,c as ce,F as me,D as fe}from"./VList-DXkKCcoE.js";import{b as D,V as S,a as H,c as pe}from"./VCard-DzPeIVHj.js";import{V as ge}from"./VForm-D1wVrR7W.js";import{e as ve}from"./VSelect-bMY2wi1p.js";import{V as be}from"./VFileInput-aqKUreP9.js";import{V as Ie}from"./VChip-m9RGjYNR.js";import{V as Ve}from"./VTextField-B5o9k15D.js";import{V as R,C as ye,q as _e,p as A}from"./VAvatar-60eLK1cy.js";import{V as $e}from"./VListItemAction-DJY-HWyY.js";import{V as xe}from"./VSpacer-hqQAeQtU.js";import{V as Fe}from"./VDialog-VYq4SPpl.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./forwardRefs-TdIUcFqw.js";import"./VOverlay-C_Thq67v.js";import"./dialog-transition-BtpIEwcb.js";/* empty css              */const he={key:1},Ce={key:0},we={key:1,class:"text-error"},m=60,Te=5,j=5e3,De=se({__name:"upload_multiple",setup(Se){const P=le();function Q(e){const s={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"},a=new Date(e);return a.setHours(a.getHours()+8),a.toLocaleString(void 0,s)}const L=c([]),V=c(null),r=c(null),x=c(3),h=c(!1),C=c("form"),d=c([]),y=c(0);let f=0;const n=new Map;let p=null;const _=c(!1),B=c("");async function W(){try{const e=await ce();L.value=e||[]}catch(e){console.error("获取测验列表失败:",e)}}async function E(){if(!(!V.value||!r.value||r.value.length===0)){if(r.value.length>m){alert(`每次最多上传${m}篇作文`);return}h.value=!0,C.value="processing",y.value=0,f=0,d.value=r.value.map(e=>({file:e,status:"pending"})),N(),M(),h.value=!1}}function M(){if(f>=d.value.length){console.log("所有批次已启动");return}const e=Math.min(f+Te,d.value.length);console.log(`开始处理批次: 从索引 ${f} 到 ${e-1}`);for(let s=f;s<e;s++)X(d.value[s]);f=e,f<d.value.length?(console.log(`安排下一批次在 ${j/1e3} 秒后开始`),p=setTimeout(M,j)):console.log("所有文件上传已安排")}async function X(e){var s,a;e.status="uploading",console.log(`上传文件: ${e.file.name}`);try{const l=await me(V.value,e.file,x.value);e.submissionId=l.submissionId,e.status="polling",console.log(`文件 ${e.file.name} 上传成功, submissionId: ${e.submissionId}. 开始轮询.`),Y(e)}catch(l){console.error(`上传文件 ${e.file.name} 失败:`,l),e.status="error",e.error=((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"上传失败",F(),w()}}function Y(e){if(!e.submissionId){console.error(`无法为文件 ${e.file.name} 启动轮询：缺少 submissionId`);return}n.has(e.submissionId)&&n.get(e.submissionId)!==null&&clearInterval(n.get(e.submissionId));const s=setInterval(()=>Z(e),2e3);n.set(e.submissionId,s),console.log(`为 submissionId ${e.submissionId} 启动轮询定时器 ID: ${s}`)}async function Z(e){var s,a;if(!e.submissionId||e.status!=="polling"){e.submissionId&&n.has(e.submissionId)&&n.get(e.submissionId)!==null&&(console.log(`停止轮询 submissionId ${e.submissionId} (状态不是 polling 或无 ID)`),clearInterval(n.get(e.submissionId)),n.delete(e.submissionId));return}try{const l=await fe(e.submissionId);l.judgeResult&&(console.log(`submissionId ${e.submissionId} 批改完成`),e.status="completed",e.finalScore=l.finalScore,n.has(e.submissionId)&&n.get(e.submissionId)!==null&&(console.log(`停止轮询 submissionId ${e.submissionId}`),clearInterval(n.get(e.submissionId)),n.delete(e.submissionId)),F(),w())}catch(l){console.error(`轮询提交 ${e.submissionId} 失败:`,l),e.status="error",e.error=((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"处理失败",n.has(e.submissionId)&&n.get(e.submissionId)!==null&&(console.log(`停止轮询 submissionId ${e.submissionId} (发生错误)`),clearInterval(n.get(e.submissionId)),n.delete(e.submissionId)),F(),w()}}function F(){const e=d.value.length;if(e===0){y.value=0;return}const s=d.value.filter(a=>a.status==="completed"||a.status==="error").length;y.value=Math.min(s/e*100,100),console.log(`当前进度: ${y.value.toFixed(2)}% (${s}/${e})`)}function w(){const e=d.value.length;if(e===0)return;d.value.filter(a=>a.status==="completed"||a.status==="error").length===e&&(console.log("所有文件处理完成"),F(),B.value="全部批改完成！",_.value=!0,p!==null&&(clearTimeout(p),p=null,console.log("清除批次定时器")),setTimeout(()=>{_.value=!1,P.push("/essays")},5e3))}function G(e){switch(e){case"pending":return"等待上传";case"uploading":return"上传中";case"polling":return"处理中";case"completed":return"已完成";case"error":return"失败";default:return e}}function J(e){if(e.preventDefault(),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0){const s=Array.from(e.dataTransfer.files),l=[...r.value?Array.from(r.value):[],...s];l.length>m?(alert(`文件总数不能超过 ${m} 篇。已自动选择前 ${m} 篇文件。`),r.value=l.slice(0,m)):r.value=l,ue(()=>{V.value&&x.value>0&&r.value&&r.value.length>0&&E()})}}function K(e){r.value&&r.value.splice(e,1)}function N(){n.forEach((e,s)=>{e!==null&&(clearInterval(e),console.log(`清除轮询定时器 ID: ${e} (submissionId: ${s})`))}),n.clear(),p!==null&&(clearTimeout(p),p=null,console.log("清除批次定时器"))}return oe(()=>{W()}),te(()=>{N()}),(e,s)=>{const a=ne("v-list-item-content");return u(),I("div",null,[s[15]||(s[15]=T("h1",{class:"text-h4 mb-4"},"批量上传作文并批改",-1)),C.value==="form"?(u(),v(S,{key:0},{default:o(()=>[t(D,null,{default:o(()=>[t(ge,{onSubmit:$(E,["prevent"])},{default:o(()=>[t(ve,{modelValue:V.value,"onUpdate:modelValue":s[0]||(s[0]=l=>V.value=l),items:L.value,"item-value":"id",label:"选择测验",required:""},{selection:o(({item:l})=>[T("span",null,b(l.raw.description),1)]),item:o(({props:l,item:g})=>[t(q,ae(l,{title:g.raw.description}),{default:o(()=>[t(z,null,{default:o(()=>[i(b(Q(g.raw.createdAt)),1)]),_:2},1024)]),_:2},1040,["title"])]),_:1},8,["modelValue","items"]),T("div",{class:"drag-file-area",onDragover:s[3]||(s[3]=$(()=>{},["prevent"])),onDragleave:s[4]||(s[4]=$(()=>{},["prevent"])),onDrop:$(J,["prevent"])},[t(be,{modelValue:r.value,"onUpdate:modelValue":s[1]||(s[1]=l=>r.value=l),label:`选择作文图片（支持拖动文件到此处选择，最多 ${m} 篇）`,accept:"image/*",required:"",multiple:"","max-files":m,"show-size":"","prepend-icon":"mdi-upload",style:{background:"transparent"},onClick:s[2]||(s[2]=$(()=>{},["stop"])),chips:""},{selection:o(({fileNames:l})=>[(u(!0),I(U,null,O(l,(g,ee)=>(u(),v(Ie,{key:g,text:g,closable:"","onClick:close":Ae=>K(ee)},null,8,["text","onClick:close"]))),128))]),_:1},8,["modelValue","label"])],32),t(Ve,{modelValue:x.value,"onUpdate:modelValue":s[5]||(s[5]=l=>x.value=l),modelModifiers:{number:!0},label:"分栏数",type:"number",required:""},null,8,["modelValue"]),t(R,{type:"submit",color:"primary",loading:h.value},{default:o(()=>s[8]||(s[8]=[i("提交")])),_:1,__:[8]},8,["loading"])]),_:1})]),_:1})]),_:1})):k("",!0),C.value==="processing"?(u(),I("div",he,[t(ye,{"model-value":y.value,color:"primary",height:"8",striped:"",class:"mb-4"},null,8,["model-value"]),t(S,null,{default:o(()=>[t(H,null,{default:o(()=>s[9]||(s[9]=[i("批量批改进度")])),_:1,__:[9]}),t(D,null,{default:o(()=>[t(ie,{dense:""},{default:o(()=>[(u(!0),I(U,null,O(d.value,(l,g)=>(u(),v(q,{key:g},{default:o(()=>[t(a,null,{default:o(()=>[t(de,null,{default:o(()=>[i(b(l.file.name),1)]),_:2},1024),t(z,null,{default:o(()=>[i(" 状态: "+b(G(l.status))+" ",1),l.status==="completed"?(u(),I("span",Ce," - 得分: "+b(l.finalScore??"N/A"),1)):k("",!0),l.status==="error"?(u(),I("span",we," - 错误: "+b(l.error??"未知错误"),1)):k("",!0)]),_:2},1024)]),_:2},1024),t($e,null,{default:o(()=>[l.status==="uploading"||l.status==="polling"?(u(),v(_e,{key:0,indeterminate:"",size:"24",width:"3",color:"primary"})):l.status==="completed"?(u(),v(A,{key:1,color:"success"},{default:o(()=>s[10]||(s[10]=[i("mdi-check-circle")])),_:1,__:[10]})):l.status==="error"?(u(),v(A,{key:2,color:"error"},{default:o(()=>s[11]||(s[11]=[i("mdi-alert-circle")])),_:1,__:[11]})):(u(),v(A,{key:3},{default:o(()=>s[12]||(s[12]=[i("mdi-dots-horizontal")])),_:1,__:[12]}))]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})])):k("",!0),t(Fe,{modelValue:_.value,"onUpdate:modelValue":s[7]||(s[7]=l=>_.value=l),persistent:"","max-width":"300"},{default:o(()=>[t(S,null,{default:o(()=>[t(H,{class:"text-h6"},{default:o(()=>s[13]||(s[13]=[i("批改完成")])),_:1,__:[13]}),t(D,null,{default:o(()=>[i(b(B.value),1)]),_:1}),t(pe,null,{default:o(()=>[t(xe),t(R,{color:"primary",variant:"text",onClick:s[6]||(s[6]=l=>{_.value=!1,re(P).push("/essays")})},{default:o(()=>s[14]||(s[14]=[i("确定")])),_:1,__:[14]})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),Ze=ke(De,[["__scopeId","data-v-6793b114"]]);export{Ze as default};
