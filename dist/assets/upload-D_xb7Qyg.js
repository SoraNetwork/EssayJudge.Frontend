import{Q as A,R as D,r as u,d as L,Y as g,W as n,H as i,V as I,a0 as V,X as a,x as t,aj as M,y as N,_ as d,Z as m,P as q,$ as U}from"./index-r3Hix-NK.js";import{V as h,x as j,c as E,F as H,D as $}from"./VList-r1kVW96Y.js";import{b as y,V as _,a as C}from"./VCard-T3_2Y51s.js";import{V as z}from"./VForm-BqHcEKv4.js";import{e as Q}from"./VSelect-BrtmYZuX.js";import{V as W}from"./VFileInput-BfnfqaKz.js";import{V as X}from"./VTextField-DI4CObfl.js";import{V as R,C as Y,q as Z}from"./VAvatar-7zVk-3Er.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./forwardRefs-TdIUcFqw.js";import"./VOverlay-B79XaCKg.js";import"./dialog-transition-BBGBBMTO.js";import"./VChip-D6GHusVG.js";const J={class:"d-flex justify-end"},K={key:1},O=A({__name:"upload",setup(ee){const S=D();function T(o){const e={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"},l=new Date(o);return l.setHours(l.getHours()+8),l.toLocaleString(void 0,e)}const k=u([]),c=u(null),f=u(null),b=u(3),x=u(!1),w=u(!1),v=u(!1),s=u({}),r=u(0);async function P(){try{const o=await E();k.value=o||[]}catch(o){console.error("获取测验列表失败:",o)}}async function B(){if(!(!c.value||!f.value)){x.value=!0,w.value=!0,r.value=0;try{const e=(await H(c.value,f.value,b.value)).submissionId;F(e)}catch(o){console.error("上传作文失败:",o),v.value=!1,r.value=0}finally{x.value=!1}}}function F(o){w.value=!1,v.value=!0,r.value=0;const e=setInterval(async()=>{try{const l=await $(o);s.value=l;let p=0;s.value.parsedText&&(p+=20),s.value.aiResults&&s.value.aiResults.length>0&&(p+=Math.min(s.value.aiResults.length,4)*20),r.value=Math.min(p,100),l.judgeResult&&(clearInterval(e),r.value=100,setTimeout(()=>{S.push(`/essays/${o}`)},500))}catch(l){console.error("轮询失败:",l),clearInterval(e),v.value=!1,s.value={},r.value=0}},2e3)}return L(()=>{P()}),(o,e)=>(n(),g("div",null,[e[8]||(e[8]=i("h1",{class:"text-h4 mb-4"},"上传作文并批改",-1)),!w.value&&!v.value?(n(),I(_,{key:0},{default:a(()=>[t(y,null,{default:a(()=>[t(z,{onSubmit:M(B,["prevent"])},{default:a(()=>[t(Q,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=l=>c.value=l),items:k.value,"item-value":"id",label:"选择测验",required:""},{selection:a(({item:l})=>[i("span",null,m(l.raw.description),1)]),item:a(({props:l,item:p})=>[t(h,N(l,{title:p.raw.description}),{default:a(()=>[t(j,null,{default:a(()=>[d(m(T(p.raw.createdAt)),1)]),_:2},1024)]),_:2},1040,["title"])]),_:1},8,["modelValue","items"]),t(W,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=l=>f.value=l),label:"选择作文图片（支持拖动文件到此处选择）",accept:"image/*",required:""},null,8,["modelValue"]),t(X,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=l=>b.value=l),modelModifiers:{number:!0},label:"分栏数",type:"number",required:""},null,8,["modelValue"]),i("div",J,[t(R,{type:"submit",color:"primary",loading:x.value,class:"mr-2"},{default:a(()=>e[3]||(e[3]=[d("提交")])),_:1,__:[3]},8,["loading"]),t(R,{color:"secondary",to:"/essays/upload_multiple","prepend-icon":"mdi-upload-multiple"},{default:a(()=>e[4]||(e[4]=[d("批量上传")])),_:1,__:[4]})])]),_:1})]),_:1})]),_:1})):V("",!0),v.value?(n(),g("div",K,[t(Y,{"model-value":r.value,color:"primary",height:"8",striped:"",class:"mb-4"},null,8,["model-value"]),t(_,{class:"mb-4"},{default:a(()=>[t(y,{class:"text-center"},{default:a(()=>[t(Z,{indeterminate:"",color:"primary",size:"64"}),e[5]||(e[5]=i("p",{class:"mt-4"},"正在批改中，请稍候...",-1)),i("p",null,"状态: "+m(s.value.status),1)]),_:1,__:[5]})]),_:1}),s.value.parsedText?(n(),I(_,{key:0,class:"mb-4"},{default:a(()=>[t(C,null,{default:a(()=>e[6]||(e[6]=[d("识别原文")])),_:1,__:[6]}),t(y,{class:"pre-wrap"},{default:a(()=>[d(m(s.value.parsedText),1)]),_:1})]),_:1})):V("",!0),s.value.aiResults&&s.value.aiResults.length>0?(n(),I(_,{key:1,class:"mb-4"},{default:a(()=>[t(C,null,{default:a(()=>e[7]||(e[7]=[d("AI 初步批改")])),_:1,__:[7]}),t(y,null,{default:a(()=>[i("ul",null,[(n(!0),g(q,null,U(s.value.aiResults,l=>(n(),g("li",{key:l.id},[i("strong",null,m(l.modelName)+":",1),d(" "+m(l.feedback)+" (得分: "+m(l.score)+") ",1)]))),128))])]),_:1})]),_:1})):V("",!0)])):V("",!0)]))}}),ce=G(O,[["__scopeId","data-v-7815c3f7"]]);export{ce as default};
